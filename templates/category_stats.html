<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ category.name }} Stats</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <!-- Inline styles have been removed -->
</head>
<body>
<div class="container">
    <header class="header">
        <h1>{{ category.name }} Stats</h1>
        <a href="{{ url_for('index') }}" class="close-btn">&times;</a>
    </header>

    <!-- Month selector will be placed here, outside the old custom header structure -->
    <div class="month-selector-container">
        <select class="month-selector" id="month-selector">
            {% if available_months %}
                {% for month_val in available_months %}
                    <option value="{{ month_val }}">{{ month_val | formatmonthyear }}</option>
                {% endfor %}
            {% else %}
                <option value="">No data available</option>
            {% endif %}
        </select>
    </div>

    <div class="category-actions">
        <a href="{{ url_for('edit_category', category_id=category.id) }}" class="button edit-action-btn">Edit Category</a>
        <button type="button" class="button delete-action-btn" id="initiate-delete-btn">Delete Category</button>
    </div>

    <div class="calendar-wrapper">
        <div class="weekdays">
            <div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div> <!-- Shorter day names -->
        </div>
        <div class="calendar" id="calendar-grid">
            <!-- Calendar days will be generated by JavaScript -->
        </div>
    </div>

    <!-- Daily Log Display Area (Initially Hidden) -->
    <div id="daily-log-display" style="display:none;">
        <h4>Logs for <span id="selected-log-date"></span></h4>
        <ul id="daily-log-list"></ul>
    </div>

    <!-- Stats Section -->
    <div class="stats-section-container"> <!-- Added a wrapper for heading + grid -->
        <h3 class="section-title">Lifetime Statistics</h3>
        <div class="stats-grid">
            <div class="stat-box">
                <h4>Total Sessions</h4>
            <div class="stat-value" id="total-sessions">{{ lifetime_stats.total_sessions }}</div>
        </div>
        <div class="stat-box">
            <h4>Lifetime Time Spent (hrs)</h4>
            <div class="stat-value" id="total-hours-spent">{{ lifetime_stats.total_hours_spent }}</div>
        </div>
        <div class="stat-box">
            <h4>Avg. Per Week (hrs)</h4>
            <div class="stat-value" id="avg-hours-week">{{ lifetime_stats.avg_hours_per_week }}</div>
        </div>
        <div class="stat-box">
            <h4>Longest Session (min)</h4>
            <div class="stat-value" id="longest-session">{{ lifetime_stats.longest_session_minutes }}</div>
        </div>
    </div>

</div> <!-- End of .container -->

    <script>
        const logEntriesData = {{ log_entries_data | tojson }};
        const availableMonths = {{ available_months | tojson }};
        const isEmptyCategory = {{ is_empty_category | tojson }}; // Pass the flag
        const calendarGrid = document.getElementById('calendar-grid');
        const monthSelector = document.getElementById('month-selector');
        const dailyLogDisplay = document.getElementById('daily-log-display');
        const selectedLogDateEl = document.getElementById('selected-log-date');
        const dailyLogListEl = document.getElementById('daily-log-list');

        function renderCalendar(yearMonth) { // yearMonth is "YYYY-MM"
            calendarGrid.innerHTML = ''; // Clear previous calendar
            dailyLogDisplay.style.display = 'none'; // Hide daily logs when month changes

            if (!yearMonth) { // If no specific month is passed (e.g. initial call for empty category)
                if (availableMonths && availableMonths.length > 0) {
                    yearMonth = availableMonths[0]; // Default to first available month
                } else {
                    // This case should ideally not be hit if backend always provides current month for empty
                    calendarGrid.innerHTML = '<p>No data available for display.</p>';
                    return;
                }
            }

            // If it's an empty category, logEntriesData for the current month will be empty or undefined.
            // The logic below will correctly render grey circles.
            // No need for a specific "No log data for this period" message if we always show a grid.

            const [year, month] = yearMonth.split('-').map(Number);
            const firstDayOfMonth = new Date(year, month - 1, 1).getDay(); // 0 (Sun) - 6 (Sat)
            const daysInMonth = new Date(year, month, 0).getDate(); // Last day of prev month = days in current

            // Add empty divs for days before the first day of the month
            for (let i = 0; i < firstDayOfMonth; i++) {
                const emptyDayCell = document.createElement('div');
                emptyDayCell.classList.add('day', 'day-inactive');
                calendarGrid.appendChild(emptyDayCell);
            }

            // Add day cells for the month
            for (let dayNum = 1; dayNum <= daysInMonth; dayNum++) {
                const dayCell = document.createElement('div');
                dayCell.classList.add('day');
                dayCell.textContent = dayNum;

                const dayHasLogs = logEntriesData[yearMonth] && logEntriesData[yearMonth][dayNum] && logEntriesData[yearMonth][dayNum].length > 0;

                if (dayHasLogs) {
                    dayCell.classList.add('day-active');
                    dayCell.dataset.date = `${yearMonth}-${String(dayNum).padStart(2, '0')}`; // YYYY-MM-DD
                    dayCell.addEventListener('click', function() {
                        displayDailyLogs(this.dataset.date);
                    });
                }
                calendarGrid.appendChild(dayCell);
            }
        }

        function displayDailyLogs(dateStr) { // dateStr is "YYYY-MM-DD"
            const [year, monthNumStr, dayNumStr] = dateStr.split('-');
            const yearMonthKey = `${year}-${monthNumStr}`;
            const dayKey = parseInt(dayNumStr);

            const entriesForDay = logEntriesData[yearMonthKey] && logEntriesData[yearMonthKey][dayKey]
                                ? logEntriesData[yearMonthKey][dayKey]
                                : [];

            // Format date for display: "Month Day, Year"
            const displayDate = new Date(parseInt(year), parseInt(monthNumStr) - 1, parseInt(dayNumStr));
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            selectedLogDateEl.textContent = displayDate.toLocaleDateString('en-US', options);

            dailyLogListEl.innerHTML = ''; // Clear previous logs

            if (entriesForDay.length > 0) {
                entriesForDay.forEach(entry => {
                    const entryCard = document.createElement('div');
                    entryCard.classList.add('log-entry-card');

                    const durationEl = document.createElement('p');
                    durationEl.innerHTML = `<strong>Duration:</strong> ${entry.duration} min.`;
                    entryCard.appendChild(durationEl);

                    if (entry.notes) {
                        const notesEl = document.createElement('p');
                        notesEl.classList.add('log-notes');
                        notesEl.innerHTML = `<strong>Notes:</strong> ${entry.notes}`;
                        entryCard.appendChild(notesEl);
                    }
                    dailyLogListEl.appendChild(entryCard);
                });
            } else {
                // This case should ideally not be hit if the day was marked active
                const noEntriesItem = document.createElement('div');
                noEntriesItem.classList.add('log-entry-card');
                noEntriesItem.textContent = 'No specific entries found for this day.';
                dailyLogListEl.appendChild(noEntriesItem);
            }
            dailyLogDisplay.style.display = 'block';
        }

        monthSelector.addEventListener('change', function() {
            renderCalendar(this.value);
        });

        // Initial render
        if (availableMonths && availableMonths.length > 0) {
            monthSelector.value = availableMonths[0]; // Select the first (and possibly only) month
            renderCalendar(availableMonths[0]);
        } else {
            // This block should ideally not be reached if backend always provides current month for empty categories
            calendarGrid.innerHTML = '<p>Error: No month data provided.</p>';
            if (monthSelector) monthSelector.disabled = true;
        }

        // If it's an empty category, the month selector might have only one option (current month)
        // and it might be "No data available" if the available_months logic in backend isn't perfect for empty.
        // However, with the backend changes, available_months should always have at least the current month.
        if (isEmptyCategory && monthSelector.options.length === 1 && monthSelector.options[0].text === "No data available") {
             // This is a fallback, ideally the filter `formatmonthyear` should make it "Month YYYY"
            monthSelector.options[0].text = new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        }
        if (isEmptyCategory && monthSelector.options.length === 1) {
             // If only one month is available (current month for empty category), no need for it to be a selector.
             // Could replace with static text, or just leave it as a disabled selector with one option.
             // For now, we'll leave it as is, but could be a UI refinement.
        }

        // More Menu Toggle JavaScript has been removed as the menu is no longer present.

        // Delete Category Modal Functionality
        const deleteModal = document.getElementById('delete-confirm-modal');
        const initiateDeleteBtn = document.getElementById('initiate-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const categoryNameModalEl = document.getElementById('delete-category-name-modal');

        const categoryNameForModal = {{ category.name | tojson }};
        const categoryIdForDelete = {{ category.id | tojson }};

        if (initiateDeleteBtn) {
            initiateDeleteBtn.addEventListener('click', () => {
                if (categoryNameModalEl) {
                    categoryNameModalEl.textContent = categoryNameForModal;
                }
                if (deleteModal) {
                    deleteModal.classList.add('modal-visible');
                }
            });
        }

        if (cancelDeleteBtn) {
            cancelDeleteBtn.addEventListener('click', () => {
                if (deleteModal) {
                    deleteModal.classList.remove('modal-visible');
                }
            });
        }

        if (confirmDeleteBtn) {
            confirmDeleteBtn.addEventListener('click', () => {
                // Construct URL using the categoryIdForDelete
                window.location.href = `/delete_category/${categoryIdForDelete}/confirm`;
            });
        }

        // Close modal if user clicks outside of modal-content (on the overlay)
        if (deleteModal) {
            deleteModal.addEventListener('click', function(event) {
                if (event.target === deleteModal) { // Check if the click is on the overlay itself
                    deleteModal.classList.remove('modal-visible');
                }
            });
        }

      </script>

    <!-- Delete Confirmation Modal -->
    <div id="delete-confirm-modal" class="modal">
        <div class="modal-content">
            <h2>Confirm Deletion</h2>
            <p>Are you sure you want to delete <strong id="delete-category-name-modal"></strong>? This will also delete all associated log entries.</p>
            <div class="modal-actions">
                <button type="button" id="cancel-delete-btn" class="button secondary-action-btn">Cancel</button>
                <button type="button" id="confirm-delete-btn" class="button delete-action-btn">Yes, Delete</button>
            </div>
        </div>
    </div>
</body>
</html>
